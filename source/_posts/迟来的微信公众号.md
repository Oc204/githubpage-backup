---
title: 迟来的微信公众号
date: 2019-09-12 09:52:29
tags: 微信公众号
---

![](/迟来的微信公众号/index.png)

微信公众号开发入门，记录一下学习的过程和心得。

<!--more-->

## 开发准备

​	<font face="楷体" size=4>

​	首先说明一下，微信公众号分为服务号、订阅号、企业号，一般个人就只能申请到订阅号，但是订阅号是基本没有什么开发权限的，但是我们可以使用微信的测试号来进行开发。测试号具备所有微信提供的开发功能权限。

​    因此在开发之前，你需要先去公众号平台申请一个账号，详细请看微信的官网公告说明。

​	</font>

---

## 一、接入微信公众号

<h4>1、获取AppID和AppSecret</h4>

进入你的微信公众号，进入底部，有一个基本配置选项，在里面可以查看到这两个字符串，AppSecret记得保存好

<h4>2、我们需要一个内网穿透工具</h4>

由于我们需要在本地进行测试，但是微信服务器需要能够在外网访问到本地的服务，因此我们可以去注册一个natapp，个人可以免费试用。

注册完成之后，我们需要根据对应的版本下载一个客户端到本地，我是windows环境，直接启动应用natapp.exe，进入命令行界面。此时，我们需要在natapp上购买一个隧道，当然，这是免费的。购买成功之后，我们会得到一个隧道，像这样

![](/迟来的微信公众号/natapp.png)

我们需要这个叫authtoken的参数，在我们的本地的命令行界面中输入`natapp -authtoken 你的authtoken`

之后可以看到以下界面，就说明你已经执行成功，可以通过这个url从外网访问到本地

![](/迟来的微信公众号/natapp_cmd.png)

来到微信之后，需要进行验证，首先需要设置一个token，用于本地和微信的服务器进行校验比对的一个东西。

之后需要填写配置，讲内网穿透获取的地址复制到微信公众号上的地址栏，验证成功，完毕。

<h4>3、校验微信签名</h4>

接入公众号的第一步，首先需要校验微信签名，校验成功之后，我们才能够进行下一步行动。

当我们访问到微信公众号之后，微信的服务器将发送一个get请求给我们，参数格式如下

![](/迟来的微信公众号/微信校验码参数.jpg)

得到请求后，我们需要做三步:

```
1. 将token、timestamp、nonce三个参数进行字典序排序
2. 将三个参数字符串拼接成一个字符串进行sha1加密 (可逆加密解密函数)
3. 开发者获得加密后的字符串可与signature对比，标识该请求来源于微信
```

签名校验成功后，说明我们已经可以与公众号正常通信了。

代码不进行演示，主要说明原理。

## 二、获取ACCESS_TOKEN

access_token是一个很重要的东西，基本上每调用一个微信接口，我们都需要它。

<h4>1、ACCESS_TOKEN是什么？</h4>

access_token是公众号的全局唯一接口调用凭据，公众号调用各接口时都需使用access_token。开发者需要进行妥善保存。access_token的存储至少要保留512个字符空间。access_token的有效期目前为2个小时，需定时刷新，重复获取将导致上次获取的access_token失效。

**总结以上说明，access_token需要做到以下两点：**

```

1.因为access_token有2个小时的时效性，要有一个机制保证最长2个小时重新获取一次。

2.因为接口调用上限每天2000次，所以不能调用太频繁。
```

1.因为access_token有2个小时的时效性，要有一个机制保证最长2个小时重新获取一次。

2.因为接口调用上限每天2000次，所以不能调用太频繁。

<h4>2、如何获取ACCESS_TOKEN？</h4>

我们需要两个参数，就是之前提到的APPID和APPSECRET，通过在给定的URL中放置我们特定的参数，然后使用GET请求发送给微信服务器，我们就可以获取到ACCESS_TOKEN。

**接口调用请求说明**

1、https请求方式: GET
2、https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=APPID&secret=APPSECRET



**参数说明**

| 参数       | 是否必须 | 说明                                  |
| ---------- | -------- | ------------------------------------- |
| grant_type | 是       | 获取access_token填写client_credential |
| appid      | 是       | 第三方用户唯一凭证                    |
| secret     | 是       | 第三方用户唯一凭证密钥，即appsecret   |

**微信返回信息说明**

```
{"access_token":"ACCESS_TOKEN","expires_in":7200}
```

获取失败示例

```
{"errcode":40013,"errmsg":"invalid appid"}
```

errcode可以在开发者文档中进行查询，进而分析失败原因。



## 三、如何回复用户消息



思路：

1、获取用户回复的消息类型，通过返回的xml模板中的MsgType进行区分，不同的消息类型的xml格式是不相同的，具体可以在开发者文档中看到，接收用户消息使用的是POST请求，在POST请求处理即可

2、根据消息类型，进行xml消息格式构造。因为微信公众号已经给好了消息模板，所以直接根据模板，返回对应信息就行。注意的是，发送消息时，ToUserName和FromUserName要反过来，因为之前是用户给我发消息，而现在是我给用户发消息

3、消息发送除了文本消息以外，返回其他的消息时，例如图片、音频，都需要一个mediaId，详情请自行百度，本处不进行具体说明



**其次我们还可以通过这个本地url实时监控我们与微信通信的结果，这是natapp的一个后台监控，返回的消息都可以看到，非常方便**

[natapp管控台]("http://localhost:4040/http/in")

![](/迟来的微信公众号/natapp管控台.png)